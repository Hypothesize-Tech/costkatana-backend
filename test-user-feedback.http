### CostKATANA User Feedback & Value Tracking API Tests
### This file demonstrates the complete User Feedback & Value Tracking workflow

### Prerequisites:
# 1. Start the backend server: npm run dev
# 2. Have a valid authentication token
# 3. Have made some gateway requests to generate request IDs

@baseUrl = http://localhost:8000/api
@authToken = YOUR_AUTH_TOKEN_HERE

### =============================================================================
### STEP 1: Make a request through the gateway to get a CostKatana-Request-Id
### =============================================================================

POST {{baseUrl}}/gateway/v1/chat/completions
Content-Type: application/json
CostKatana-Auth: Bearer dak_68790a13c350ea09cde79fb1_b7ef552ac7ebb2002ec2723470f457ea_25efb247a5aa737374326e2a0ab93388d273071784ffab2c5281d4d58736b471
CostKatana-Target-Url: https://api.openai.com
CostKatana-Request-Id: feedback-test-{{$timestamp}}

{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": "How do I return an item to your store?"
    }
  ],
  "max_tokens": 150
}

### =============================================================================
### STEP 2: Submit positive feedback for the request
### =============================================================================

POST {{baseUrl}}/v1/request/feedback-test-{{$timestamp}}/feedback
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "rating": true,
  "comment": "Very helpful response! The AI provided clear steps for returning items.",
  "implicitSignals": {
    "copied": true,
    "conversationContinued": false,
    "immediateRephrase": false,
    "sessionDuration": 45000,
    "codeAccepted": null
  }
}

### =============================================================================
### STEP 3: Submit negative feedback for another request
### =============================================================================

POST {{baseUrl}}/v1/request/feedback-test-negative-{{$timestamp}}/feedback
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "rating": false,
  "comment": "The response was confusing and didn't answer my question properly.",
  "implicitSignals": {
    "copied": false,
    "conversationContinued": false,
    "immediateRephrase": true,
    "sessionDuration": 8000
  }
}

### =============================================================================
### STEP 4: Get feedback for a specific request
### =============================================================================

GET {{baseUrl}}/v1/request/feedback-test-{{$timestamp}}/feedback
Authorization: Bearer {{authToken}}

### =============================================================================
### STEP 5: Update implicit signals for a request
### =============================================================================

PUT {{baseUrl}}/v1/request/feedback-test-{{$timestamp}}/implicit-signals
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "copied": true,
  "conversationContinued": true,
  "sessionDuration": 120000,
  "codeAccepted": false
}

### =============================================================================
### STEP 6: Get user feedback analytics (Return on AI Spend)
### =============================================================================

GET {{baseUrl}}/v1/feedback/analytics
Authorization: Bearer {{authToken}}

### =============================================================================
### STEP 7: Get global feedback analytics (admin view)
### =============================================================================

GET {{baseUrl}}/v1/feedback/analytics/global
Authorization: Bearer {{authToken}}

### =============================================================================
### Example Use Case: Support Bot ROI Analysis
### =============================================================================

# This demonstrates how to track the cost-effectiveness of an AI support bot

### Make a support bot request
POST {{baseUrl}}/gateway/v1/chat/completions
Content-Type: application/json
CostKatana-Auth: Bearer dak_68790a13c350ea09cde79fb1_b7ef552ac7ebb2002ec2723470f457ea_25efb247a5aa737374326e2a0ab93388d273071784ffab2c5281d4d58736b471
CostKatana-Target-Url: https://api.openai.com
CostKatana-Request-Id: support-bot-{{$timestamp}}
CostKatana-Property-Feature: support-bot

{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "system",
      "content": "You are a helpful customer support assistant for an e-commerce store."
    },
    {
      "role": "user",
      "content": "I received a damaged product. What should I do?"
    }
  ],
  "max_tokens": 200
}

### Submit feedback for the support bot response
POST {{baseUrl}}/v1/request/support-bot-{{$timestamp}}/feedback
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "rating": true,
  "comment": "Perfect! The bot provided exactly the steps I needed.",
  "implicitSignals": {
    "copied": true,
    "conversationContinued": false,
    "immediateRephrase": false,
    "sessionDuration": 30000
  }
}

### =============================================================================
### Expected Analytics Results:
### =============================================================================

# The analytics endpoint will return data like:
# {
#   "success": true,
#   "data": {
#     "totalRequests": 3,
#     "ratedRequests": 3,
#     "positiveRatings": 2,
#     "negativeRatings": 1,
#     "totalCost": 0.012,
#     "positiveCost": 0.008,
#     "negativeCost": 0.004,
#     "averageRating": 0.67,
#     "costPerPositiveRating": 0.004,
#     "costPerNegativeRating": 0.004,
#     "ratingsByProvider": {
#       "openai": {
#         "positive": 2,
#         "negative": 1,
#         "cost": 0.012
#       }
#     },
#     "ratingsByModel": {
#       "gpt-4o-mini": {
#         "positive": 2,
#         "negative": 1,
#         "cost": 0.012
#       }
#     },
#     "ratingsByFeature": {
#       "support-bot": {
#         "positive": 1,
#         "negative": 0,
#         "cost": 0.004
#       }
#     },
#     "implicitSignalsAnalysis": {
#       "copyRate": 0.67,
#       "continuationRate": 0.33,
#       "rephraseRate": 0.33,
#       "codeAcceptanceRate": 0.0,
#       "averageSessionDuration": 55000
#     }
#   }
# }

### =============================================================================
### Key Business Insights You Can Now Answer:
### =============================================================================

# 1. "What percentage of our AI spend is on negatively-rated responses?"
#    Answer: negativeCost / totalCost = $0.004 / $0.012 = 33%

# 2. "Which features have the highest ROI?"
#    Answer: Look at ratingsByFeature - support-bot has 100% positive rating

# 3. "Are users actually finding our AI responses helpful?"
#    Answer: averageRating = 67% positive, copyRate = 67%

# 4. "Should we continue using gpt-4o-mini or switch models?"
#    Answer: Check ratingsByModel for cost vs satisfaction

# 5. "How much money are we wasting on unhelpful responses?"
#    Answer: negativeCost shows exact dollar amount wasted