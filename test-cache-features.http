### CostKATANA Cost-Saving Cache Feature Tests
### This file demonstrates all the advanced caching capabilities

### Variables
@baseUrl = http://localhost:8000
@authToken = Bearer dak_68790a13c350ea09cde79fb1_b7ef552ac7ebb2002ec2723470f457ea_25efb247a5aa737374326e2a0ab93388d273071784ffab2c5281d4d58736b471

### 1. Basic Cache Test - First Request (MISS)
POST {{baseUrl}}/gateway/v1/chat/completions
Content-Type: application/json
CostKatana-Auth: {{authToken}}
CostKatana-Target-Url: https://api.openai.com
CostKatana-Cache-Enabled: true

{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": "What is the capital of France?"
    }
  ],
  "max_tokens": 50
}

### 2. Basic Cache Test - Second Request (HIT)
POST {{baseUrl}}/gateway/v1/chat/completions
Content-Type: application/json
CostKatana-Auth: {{authToken}}
CostKatana-Target-Url: https://api.openai.com
CostKatana-Cache-Enabled: true

{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": "What is the capital of France?"
    }
  ],
  "max_tokens": 50
}

### 3. Custom TTL Cache Test (1 hour)
POST {{baseUrl}}/gateway/v1/chat/completions
Content-Type: application/json
Cache-Control: max-age=3600
CostKatana-Auth: {{authToken}}
CostKatana-Target-Url: https://api.openai.com
CostKatana-Cache-Enabled: true

{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": "What is the weather like today?"
    }
  ],
  "max_tokens": 50
}

### 4. User-Scoped Cache Test - User A
POST {{baseUrl}}/gateway/v1/chat/completions
Content-Type: application/json
CostKatana-Auth: {{authToken}}
CostKatana-Target-Url: https://api.openai.com
CostKatana-Cache-Enabled: true
CostKatana-Cache-User-Scope: user_123

{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": "Tell me a joke"
    }
  ],
  "max_tokens": 100
}

### 5. User-Scoped Cache Test - User B (Different Response)
POST {{baseUrl}}/gateway/v1/chat/completions
Content-Type: application/json
CostKatana-Auth: {{authToken}}
CostKatana-Target-Url: https://api.openai.com
CostKatana-Cache-Enabled: true
CostKatana-Cache-User-Scope: user_456

{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": "Tell me a joke"
    }
  ],
  "max_tokens": 100
}

### 6. Bucket Cache Test - Multiple Responses for Variety (First Request)
POST {{baseUrl}}/gateway/v1/chat/completions
Content-Type: application/json
CostKatana-Auth: {{authToken}}
CostKatana-Target-Url: https://api.openai.com
CostKatana-Cache-Enabled: true
CostKatana-Cache-Bucket-Max-Size: 3

{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": "Give me a creative writing prompt"
    }
  ],
  "max_tokens": 150,
  "temperature": 0.8
}

### 7. Bucket Cache Test - Second Request (Will be cached separately)
POST {{baseUrl}}/gateway/v1/chat/completions
Content-Type: application/json
CostKatana-Auth: {{authToken}}
CostKatana-Target-Url: https://api.openai.com
CostKatana-Cache-Enabled: true
CostKatana-Cache-Bucket-Max-Size: 3

{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": "Give me a creative writing prompt"
    }
  ],
  "max_tokens": 150,
  "temperature": 0.8
}

### 8. Bucket Cache Test - Third Request (Will be cached separately)
POST {{baseUrl}}/gateway/v1/chat/completions
Content-Type: application/json
CostKatana-Auth: {{authToken}}
CostKatana-Target-Url: https://api.openai.com
CostKatana-Cache-Enabled: true
CostKatana-Cache-Bucket-Max-Size: 3

{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": "Give me a creative writing prompt"
    }
  ],
  "max_tokens": 150,
  "temperature": 0.8
}

### 9. Bucket Cache Test - Fourth Request (Should rotate through cached responses)
POST {{baseUrl}}/gateway/v1/chat/completions
Content-Type: application/json
CostKatana-Auth: {{authToken}}
CostKatana-Target-Url: https://api.openai.com
CostKatana-Cache-Enabled: true
CostKatana-Cache-Bucket-Max-Size: 3

{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": "Give me a creative writing prompt"
    }
  ],
  "max_tokens": 150,
  "temperature": 0.8
}

### 10. Combined Features Test - User Scope + Custom TTL + Bucket
POST {{baseUrl}}/gateway/v1/chat/completions
Content-Type: application/json
Cache-Control: max-age=7200
CostKatana-Auth: {{authToken}}
CostKatana-Target-Url: https://api.openai.com
CostKatana-Cache-Enabled: true
CostKatana-Cache-User-Scope: premium_user_789
CostKatana-Cache-Bucket-Max-Size: 5

{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": "Explain quantum computing in simple terms"
    }
  ],
  "max_tokens": 200,
  "temperature": 0.7
}

### 11. Development Environment Test - 24 Hour Cache
POST {{baseUrl}}/gateway/v1/chat/completions
Content-Type: application/json
Cache-Control: max-age=86400
CostKatana-Auth: {{authToken}}
CostKatana-Target-Url: https://api.openai.com
CostKatana-Cache-Enabled: true
CostKatana-Cache-User-Scope: dev_environment

{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": "Explain the Cost-Saving Cache feature"
    }
  ],
  "max_tokens": 300
}

### 12. Get Cache Statistics
GET {{baseUrl}}/gateway/cache/stats
Authorization: {{authToken}}

### 13. Clear Expired Cache Entries
DELETE {{baseUrl}}/gateway/cache?expired=true
Authorization: {{authToken}}

### 14. Clear Cache for Specific User Scope
DELETE {{baseUrl}}/gateway/cache?userScope=user_123
Authorization: {{authToken}}

### 15. Clear All Cache (Use with caution)
DELETE {{baseUrl}}/gateway/cache
Authorization: {{authToken}}

### 16. Verify Cache Status Headers
# Look for these headers in responses:
# - CostKatana-Cache-Status: HIT or MISS
# - First request should show MISS
# - Subsequent identical requests should show HIT

### 17. Test Cache Miss with Different Parameters
POST {{baseUrl}}/gateway/v1/chat/completions
Content-Type: application/json
CostKatana-Auth: {{authToken}}
CostKatana-Target-Url: https://api.openai.com
CostKatana-Cache-Enabled: true

{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": "What is the capital of France?"
    }
  ],
  "max_tokens": 100,
  "temperature": 0.5
}

### Notes:
### - The first request with identical parameters will show CostKatana-Cache-Status: MISS
### - Subsequent identical requests will show CostKatana-Cache-Status: HIT
### - Different user scopes create separate cache namespaces
### - Bucket caching provides response variety for creative tasks
### - Custom TTL via Cache-Control overrides default 7-day cache duration
### - Cache statistics endpoint shows detailed cache state
### - Cache can be cleared selectively by user scope or expired entries