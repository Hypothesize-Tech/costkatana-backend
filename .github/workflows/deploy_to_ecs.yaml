name: Deploy to ECS Production

on:
  push:
    branches:
      - master
      - devops

  pull_request:
    branches:
      - qa

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
      ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
      # Task definition and service name (with defaults if not in secrets)
      ECS_TASK_DEFINITION: ${{ secrets.ECS_TASK_DEFINITION || 'ck-prod-td' }}
      ECS_SERVICE_NAME: ${{ secrets.ECS_SERVICE_NAME || 'ck-prod-td-service-lggotxj9' }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      S3_URL: ${{ secrets.S3_URL}}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to Amazon ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin "${AWS_ACCOUNT_ID}.dkr.ecr.$AWS_REGION.amazonaws.com"

      - name: Download environment file from S3
        run: |
          aws s3 cp s3://ck-prod-env/.env .env

      - name: Debug environment variables
        run: echo "ECR_REPOSITORY=${ECR_REPOSITORY}"

      - name: Build and Push Docker Image
        run: |
          echo "Building Docker image..."
          docker build \
            --progress=plain \
            -t "${ECR_REPOSITORY}:latest" . || {
            echo "‚ùå Docker build failed. Check the logs above for details."
            exit 1
          }
          echo "‚úÖ Docker build successful. Tagging image..."
          docker tag "${ECR_REPOSITORY}:latest" "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:latest"
          echo "Pushing Docker image to ECR..."
          docker push "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:latest"
          echo "‚úÖ Image pushed successfully to ECR"

      - name: Update ECS Task Definition
        id: task-def
        run: |
          echo "üìã Fetching current task definition: ${ECS_TASK_DEFINITION}"
          
          # Fetch the current task definition (get latest revision)
          task_def=$(aws ecs describe-task-definition \
            --task-definition "${ECS_TASK_DEFINITION}" \
            --region "${AWS_REGION}" \
            --query 'taskDefinition' \
            --output json)

          if [ -z "$task_def" ] || [ "$task_def" == "null" ]; then
            echo "‚ùå Failed to fetch task definition"
            exit 1
          fi

          echo "‚úÖ Task definition fetched successfully"

          # Clean the task definition by removing unwanted fields and update image
          new_task_def=$(echo "$task_def" | jq '
            del(.status, .revision, .taskDefinitionArn, .requiresAttributes, .registeredAt, .registeredBy, .compatibilities) |
            .containerDefinitions[0].image = "'${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:latest'"
          ')

          # Save the cleaned task definition to a file
          echo "$new_task_def" > ecsTaskDef.json
          echo "‚úÖ Task definition prepared"

      - name: Register Updated Task Definition
        id: register-task
        run: |
          echo "üìù Registering new task definition..."
          
          register_output=$(aws ecs register-task-definition \
            --cli-input-json file://ecsTaskDef.json \
            --region "${AWS_REGION}")
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Failed to register task definition"
            exit 1
          fi

          # Extract the new task definition ARN
          TASK_DEF_ARN=$(echo "$register_output" | jq -r '.taskDefinition.taskDefinitionArn')
          TASK_DEF_REVISION=$(echo "$register_output" | jq -r '.taskDefinition.revision')
          
          echo "‚úÖ Task definition registered: ${TASK_DEF_ARN}"
          echo "task-def-arn=${TASK_DEF_ARN}" >> $GITHUB_OUTPUT
          echo "task-def-revision=${TASK_DEF_REVISION}" >> $GITHUB_OUTPUT
          echo "task-def-family=${ECS_TASK_DEFINITION}" >> $GITHUB_OUTPUT

      - name: Update ECS Service to Use New Task Definition
        run: |
          echo "üöÄ Updating ECS service: ${ECS_SERVICE_NAME}"
          echo "   Task Definition: ${ECS_TASK_DEFINITION}:${{ steps.register-task.outputs.task-def-revision }}"
          
          # Update service with explicit task definition
          update_output=$(aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_SERVICE_NAME}" \
            --task-definition "${ECS_TASK_DEFINITION}:${{ steps.register-task.outputs.task-def-revision }}" \
            --desired-count 4 \
            --force-new-deployment \
            --region "${AWS_REGION}")
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Failed to update ECS service"
            exit 1
          fi

          echo "‚úÖ Service update initiated"
          echo "$update_output" | jq '{serviceName: .service.serviceName, status: .service.status, taskDefinition: .service.taskDefinition, desiredCount: .service.desiredCount}'

      - name: Wait for Service to Stabilize
        run: |
          echo "‚è≥ Waiting for service deployment to stabilize (this may take 5-10 minutes)..."
          
          aws ecs wait services-stable \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_SERVICE_NAME}" \
            --region "${AWS_REGION}"
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Service deployment completed successfully!"
            
            # Get final service status
            aws ecs describe-services \
              --cluster "${ECS_CLUSTER}" \
              --services "${ECS_SERVICE_NAME}" \
              --region "${AWS_REGION}" \
              --query 'services[0].{ServiceName:serviceName,Status:status,TaskDefinition:taskDefinition,RunningCount:runningCount,DesiredCount:desiredCount}' \
              --output json | jq .
          else
            echo "‚ùå Service deployment failed or timed out"
            exit 1
          fi
